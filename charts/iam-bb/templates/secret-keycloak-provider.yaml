{{ if or .Values.iam.keycloak.configuration.useCrossplane .Values.iam.keycloak.configuration.useKeycloakConfigCli -}}
{{/* Note: This secret is mounted into the Keycloak Config CLI container and thus required even if only the realm is created. */ -}}
{{ if not .Values.iam.keycloak.configuration.provider.secretRef.name -}}
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: keycloak-provider
  namespace: {{ .Release.Namespace }}
  labels:
    type: provider-credentials
{{- $Secret := .Values.iam.keycloak.configuration.provider.clientSecret | default (randAlphaNum 32) | quote }}
{{- if and (not .Values.iam.keycloak.configuration.provider.clientSecret) .Values.iam.keycloak.configuration.useSecretGenerator }}
  # Note: Secret generation via k8s-secret-generator was selected,
  # but is not supported here. The actual secret was generated using Helm.
  #annotations:
  #  secret-generator.v1.mittwald.de/autogenerate: client_secret
{{- end }}
stringData:
  # A plain secret format is documented here: https://github.com/crossplane-contrib/provider-keycloak/tree/main?tab=readme-ov-file#configuration
  # However, it does not really seem to work. Therefore a "mixed" approach is used for now.
  # The "credentials" attribute contains the actual configuration, while the other attributes
  # are only informational. Unfortunately there seems to be no way to generate
  # a password into the embedded configuration through kubernetes-secret-generator.
  client_id: "crossplane-keycloak-provider"
  client_secret: {{ $Secret }}
  url: {{ or .Values.iam.keycloak.internalUrl .Values.iam.keycloak.url }}
  base_path: ""
  realm: {{ .Values.iam.keycloak.configuration.realm.name }}
  credentials: |
    {
      "client_id": "crossplane-keycloak-provider",
      "client_secret": {{ $Secret }},
      "url": {{ or .Values.iam.keycloak.internalUrl .Values.iam.keycloak.url | quote }},
      "base_path": "",
      "realm": {{ .Values.iam.keycloak.configuration.realm.name | quote }}
    }
{{- end }}
{{- end }}